var http = require('http');
var sys  = require('sys');
var fs   = require('fs');

var blacklist = [];

try {
	fs.watchFile('./conf/blacklist', function(c,p) { updateBlacklist(); });
	fs.watchFile('./conf/whitelist', function(c,p) { updateWhitelist(); });
} catch (err){
	sys.log(err);
}
	
function updateBlacklist() {
	sys.log("Updating blacklist.");
	try{
		blacklist = fs.readFileSync('./conf/blacklist', encoding='utf8').split('\n')
	                .filter(function(rx) { return rx.length })
	                .map(function(rx) { return RegExp(rx) });
	} catch (err) {
		sys.log(err);
	}
}

function updateWhitelist() {
  	sys.log("Updating iplist.");
  	try{
	  	iplist = fs.readFileSync('./conf/whitelist', encoding='utf8').split('\n')
	           .filter(function(ip) { return ip.length });
	} catch (err) {
		sys.log(err);
	}
}

function checkBlacklist(request, response){
  for (i in blacklist) {
    if (blacklist[i].test(request.url)) {
	    sys.log("Denied: " + request.method + " " + request.url);
	    response.end();
	    return;
    }
  }
}

http.createServer(function(request, response) {
  
  sys.log(request.connection.remoteAddress + ": " + request.method + " " + request.url);
  
  checkBlacklist(request, response);
  checkWhitelist(request, response);
  validate(request, response);
  
  var options = {
    hostname: 'localhost',
    port: 8080,
    path: request.url,
    method: request.method,
  	request.headers.host = '';
    headers: request.headers
  };
  
  var proxy_request = http.request(options);
  /*
  console.log('################################');
  console.log(proxy_request);
  console.log('################################');
  */
  
  sys.log(request.url);
  
  proxy_request.addListener('response', function (proxy_response) {
  
  //proxy_response.setEncoding('utf8');
  proxy_response.addListener('data', function(chunk) {
    response.write(chunk, 'binary');
    sys.log('proxy_response.listener - wrote chunk');
  });
  
  proxy_response.addListener('end', function() {
    sys.log('proxy_response.listener - end');
    response.end();
  });
  
    proxy_response.addListener('error', function(error) {
      sys.log('request.listener - error: ' + error);
    });
  
  response.writeHead(proxy_response.statusCode, proxy_response.headers);
  });
  
  request.addListener('data', function(chunk) {
  proxy_request.write(chunk, 'binary');
  sys.log('request.listener - wrote chunk');
  });
  
  request.addListener('end', function() {
  sys.log('request.listener - end');
  proxy_request.end();
  });
  
  request.addListener('error', function(error) {
  sys.log('request.listener - error: ' + error);
  });
  
}).listen(8081);

updateBlacklist();
updateWhitelist();