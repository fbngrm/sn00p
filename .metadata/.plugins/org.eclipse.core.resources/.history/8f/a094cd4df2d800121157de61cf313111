var http = require('http');
var sys  = require('sys');

http.createServer(function(request, response) {
  
  sys.log(request.connection.remoteAddress + ": " + request.method + " " + request.url);
  
  var options = {
      hostname: 'reload.de',
      port: 80,
      path: request.url,
      method: request.method,
      headers: request.headers,
      user-agent: request.user-agent
  };
  
  var proxy_request = http.request(options);
  console.log(proxy_request);
  
  proxy_request.addListener('response', function (proxy_response) {
    
    //proxy_response.setEncoding('utf8');
    
    proxy_response.addListener('data', function(chunk) {
      response.write(chunk, 'binary');
      sys.log('proxy_response.listener - wrote chunk');
    });
    
    proxy_response.addListener('end', function() {
      sys.log('proxy_response.listener - end');
      response.end();
    });
    
  	proxy_response.addListener('error', function(error) {
    	sys.log('request.listener - error: ' + error);
  	});
    
    response.writeHead(proxy_response.statusCode, proxy_response.headers);
  });
  
  request.addListener('data', function(chunk) {
    proxy_request.write(chunk, 'binary');
    sys.log('request.listener - wrote chunk');
  });
  
  request.addListener('end', function() {
    sys.log('request.listener - end');
    proxy_request.end();
  });
  
  request.addListener('error', function(error) {
    sys.log('request.listener - error: ' + error);
  });
  
}).listen(8081);